<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>Data Personil</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="../css/data-personil.css">
</head>
<body>
<header>
  <a href="database.html" class="back-btn">‚Üê Kembali</a>
  <h1>Data Personil</h1>
</header>

<div class="container">
  <div id="alertContainer"></div>
  
  <!-- Loading Banner -->
  <div id="loadingBanner" class="loading-banner">
    <div class="loading-spinner"></div>
    <span>Memuat data personil dari server...</span>
  </div>
  
  <div class="form-card">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; flex-wrap: wrap; gap: 10px;">
      <h2 style="margin: 0;">
        üìù Form Data Personil
      </h2>
      <a href="database.html" class="btn-list">üìã List Daftar Personil</a>
    </div>
    <form id="personilForm">
      <!-- SECTION: PILIH UNIT & NAMA -->
      <div class="section-selector">
        <h3>üéØ Pilih Unit & Nama</h3>
        
        <div class="form-group">
          <label for="unit">Unit Kerja Saat Ini *</label>
          <select id="unit" required>
            <option value="">-- Pilih Unit Kerja --</option>
            <option value="AKMIL">AKMIL</option>
            <option value="BANDONGAN">BANDONGAN</option>
            <option value="BOROBUDUR">BOROBUDUR</option>
            <option value="BOTTON">BOTTON</option>
            <option value="CANDIMULYO">CANDIMULYO</option>
            <option value="GLAGAH">GLAGAH</option>
            <option value="GRABAG">GRABAG</option>
            <option value="KAJORAN">KAJORAN</option>
            <option value="KALIANGKRIK">KALIANGKRIK</option>
            <option value="KARANGGADING">KARANGGADING</option>
            <option value="KC MAGELANG">KC MAGELANG</option>
            <option value="KCP SHOPPING">KCP SHOPPING</option>
            <option value="KRASAK">KRASAK</option>
            <option value="MAGELANG SELATAN">MAGELANG SELATAN</option>
            <option value="MAGELANG UTARA">MAGELANG UTARA</option>
            <option value="MERTOYUDAN">MERTOYUDAN</option>
            <option value="NGABLAK">NGABLAK</option>
            <option value="PAKIS">PAKIS</option>
            <option value="PAYAMAN">PAYAMAN</option>
            <option value="REJOWINANGUN">REJOWINANGUN</option>
            <option value="SALAMAN">SALAMAN</option>
            <option value="SECANG">SECANG</option>
            <option value="SUKARNO HATTA">SUKARNO HATTA</option>
            <option value="TEGALREJO">TEGALREJO</option>
            <option value="TEMPURAN">TEMPURAN</option>
            <option value="WINDUSARI">WINDUSARI</option>
          </select>
        </div>

        <div class="form-group hidden" id="namaSelectGroup">
          <label for="namaSelect">Pilih Nama (opsional)</label>
          <select id="namaSelect">
            <option value="">-- Pilih Nama --</option>
          </select>
          <div id="namaLoadingIndicator" class="loading-text" style="display: none;">
            <div class="loading-spinner-small"></div>
            <span>Memuat daftar nama...</span>
          </div>
        </div>
      </div>

      <!-- SECTION: DATA PERSONIL -->
      <div class="section-data hidden" id="dataPersonilSection">
        <h3>üìù Data Personil</h3>
        
        <div class="form-group">
          <label for="nama">Nama Lengkap *</label>
          <input type="text" id="nama" required placeholder="Pilih unit terlebih dahulu..." disabled>
          
          <!-- Unit Info & Pindah Unit Button -->
          <div class="unit-info-container" id="unitInfoContainer">
            <div class="unit-info-text">
              UNIT: <span id="currentUnitText">-</span>
            </div>
            <button type="button" class="btn-pindah-unit" id="btnPindahUnit" onclick="openPindahUnitModal()">
              üîÑ Pindah Unit
            </button>
          </div>
        </div>

      <div class="form-group">
        <label for="jabatan">Jabatan *</label>
        <select id="jabatan" required>
          <option value="">-- Pilih Jabatan --</option>
          <option value="DEFINITIF">DEFINITIF</option>
          <option value="PGS UNIT">PGS UNIT</option>
          <option value="PGS TERAS">PGS TERAS</option>
        </select>
      </div>

      <div class="form-group">
        <label for="nohp">No HP *</label>
        <input type="tel" id="nohp" required placeholder="08xxxxxxxxxx">
      </div>

      <div class="form-group">
        <label for="email">Alamat Email *</label>
        <input type="email" id="email" required placeholder="contoh@email.com">
        <small id="emailError" style="color: #ff4757; display: none; margin-top: 5px;">Format email tidak valid</small>
      </div>

      <div class="form-group">
        <label for="provinsi">Provinsi *</label>
        <select id="provinsi" required>
          <option value="">-- Pilih Provinsi --</option>
        </select>
      </div>

      <div class="form-group">
        <label for="kabkota">Kota/Kabupaten *</label>
        <select id="kabkota" required disabled>
          <option value="">-- Pilih Kota/Kabupaten --</option>
        </select>
      </div>

      <div class="form-group">
        <label for="kecamatan">Kecamatan *</label>
        <select id="kecamatan" required disabled>
          <option value="">-- Pilih Kecamatan --</option>
        </select>
      </div>

      <div class="form-group">
        <label for="kelurahan">Kelurahan/Desa *</label>
        <select id="kelurahan" required disabled>
          <option value="">-- Pilih Kelurahan/Desa --</option>
        </select>
      </div>

      <div class="form-group">
        <label for="dusun">Dusun/Lingkungan</label>
        <input type="text" id="dusun" placeholder="Masukkan nama dusun (opsional)">
      </div>

      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
        <div class="form-group">
          <label for="rt">RT *</label>
          <input type="text" id="rt" required placeholder="001" maxlength="3">
        </div>
        <div class="form-group">
          <label for="rw">RW *</label>
          <input type="text" id="rw" required placeholder="001" maxlength="3">
        </div>
      </div>

      <div class="form-group">
        <label>Upload Foto *</label>
        <div class="photo-upload" onclick="document.getElementById('foto').click()">
          <input type="file" id="foto" accept="image/*" required>
          <div id="uploadText">
            üì∑ Klik untuk ambil gambar dari galeri<br>
            <small style="color: #999;">Format: JPG, PNG (Max 10MB)</small><br>
            <small style="color: #1976d2; font-weight: 500; margin-top: 8px; display: block;">
              üìá Foto untuk ID Card
            </small>
            <small style="color: #ff6b6b; font-weight: 500; margin-top: 5px; display: block;">
              ‚ö†Ô∏è Seragam PDH, Foto Terbaru, Posisi Miring ke Kiri
            </small>
          </div>
        </div>
        
        <!-- Button to view old photo (outside upload area) -->
        <button type="button" id="btnViewDatabasePhotoStatic" class="btn-view-database-photo" onclick="viewDatabasePhoto()" style="display: none; margin-top: 10px;">
          üëÅÔ∏è Lihat Foto Database
        </button>
        
        <!-- Single Photo Preview (for new data) -->
        <div id="photoPreviewContainer" class="photo-preview-container">
          <img id="photoPreview" class="photo-preview" alt="Preview">
          <div class="photo-action-buttons">
            <button type="button" class="btn-photo-action btn-change-photo" onclick="document.getElementById('foto').click()">
              üîÑ Ubah Foto
            </button>
            <button type="button" class="btn-photo-action btn-remove-photo" onclick="removePhoto()">
              ‚ùå Hapus Foto
            </button>
          </div>
          <!-- Button to view old photo (only show in edit mode after selecting new photo) -->
          <button type="button" id="btnViewOldPhoto" class="btn-view-database-photo" onclick="viewDatabasePhoto()" style="display: none;">
            üëÅÔ∏è Lihat Foto Database
          </button>
        </div>
        
        <!-- Photo Comparison (for edit mode with new photo) -->
        <div id="photoComparisonContainer" class="photo-comparison-container">
          <div class="comparison-header">
            <span class="comparison-title">üì∏ Perbandingan Foto</span>
          </div>
          <div class="photo-comparison-grid">
            <div class="photo-compare-box">
              <div class="photo-compare-label-top">FOTO LAMA</div>
              <img id="photoOld" class="photo-compare-img" alt="Foto Lama">
              <div class="photo-compare-caption">Foto saat ini di database</div>
            </div>
            <div class="photo-compare-arrow">
              <div class="arrow-icon">‚Üí</div>
              <div class="arrow-text">Akan diganti</div>
            </div>
            <div class="photo-compare-box highlight">
              <div class="photo-compare-label-top new">FOTO BARU</div>
              <img id="photoNew" class="photo-compare-img" alt="Foto Baru">
              <div class="photo-compare-caption">Foto yang baru dipilih</div>
            </div>
          </div>
          <div class="comparison-actions">
            <button type="button" class="btn-comparison btn-cancel-change" onclick="cancelPhotoChange()">
              ‚ùå Batalkan Perubahan
            </button>
            <button type="button" class="btn-comparison btn-keep-change" onclick="keepPhotoChange()">
              ‚úÖ Gunakan Foto Baru
            </button>
          </div>
        </div>
        <div id="photoExampleContainer" style="margin-top: 20px; padding: 20px; background: #e3f2fd; border-radius: 10px; border: 2px solid #bbdefb;">
          <div style="font-weight: 600; color: #1976d2; margin-bottom: 15px; text-align: center;">üìã Contoh Foto yang Benar</div>
          <img id="photoExample" src="../assets/contohfoto.jpg" alt="Contoh Foto" style="max-width: 100%; max-height: 400px; border-radius: 10px; display: block; margin: 0 auto; box-shadow: 0 4px 12px rgba(0,0,0,0.15);">
          <small style="display: block; text-align: center; color: #666; margin-top: 15px; line-height: 1.8; background: white; padding: 12px; border-radius: 8px;">
            ‚úì <strong>Posisi 3/4 profile menghadap ke kiri</strong> (seperti foto KTP/SIM)<br>
            ‚úì Mengenakan <strong>seragam PDH lengkap dengan atribut</strong><br>
            ‚úì Foto terbaru, jelas, dan profesional<br>
            ‚úì Background netral/polos (putih/abu-abu/lainnya)<br>
            ‚úì Pencahayaan merata, tidak silau atau gelap
          </small>
        </div>
      </div>
      <!-- END SECTION: DATA PERSONIL -->
      </div>

      <div id="submitSection" class="hidden">
        <div class="progress-container" id="progressContainer">
          <div class="progress-bar">
            <div class="progress-fill" id="progressFill">0%</div>
          </div>
        </div>

        <button type="submit" class="btn-submit" id="submitBtn">‚úì Simpan Data Personil</button>
      </div>
    </form>
  </div>

</div>

<!-- Modal Success -->
<div id="successModal" class="modal-overlay">
  <div class="modal-content">
    <div class="modal-icon">‚úÖ</div>
    <div class="modal-title">Data Berhasil Disimpan!</div>
    <div class="modal-message">
      Data personil telah berhasil disimpan ke database Google Spreadsheet.
    </div>
    <button class="modal-btn" onclick="closeSuccessModal()">OK, Mengerti</button>
  </div>
</div>

<!-- Modal Duplicate Email Confirmation -->
<div id="duplicateModal" class="modal-overlay">
  <div class="modal-content">
    <div class="modal-icon">‚ö†Ô∏è</div>
    <div class="modal-title">Data Sudah Ada!</div>
    <div class="modal-message">
      Sudah ada nama <strong id="duplicateName"></strong> di unit <strong id="duplicateUnit"></strong>.<br><br>
      Apakah Anda ingin mengupdate data yang sudah ada?<br><br>
      <strong style="color: #ff6b6b;">Masukkan email untuk konfirmasi:</strong>
    </div>
    <input type="email" id="confirmEmail" class="modal-input" placeholder="Masukkan email untuk konfirmasi">
    <div class="modal-error-text" id="emailMismatchError">Email tidak sesuai dengan data form!</div>
    <div style="display: flex; gap: 10px; justify-content: center; margin-top: 10px;">
      <button class="modal-btn modal-btn-cancel" onclick="closeDuplicateModal()">Batal</button>
      <button class="modal-btn" onclick="confirmUpdate()">Update Data</button>
    </div>
  </div>
</div>

<!-- Modal Duplicate Name in Other Unit -->
<div id="duplicateNameModal" class="modal-overlay">
  <div class="modal-content">
    <div class="modal-icon">üë•</div>
    <div class="modal-title">Nama Sama Ditemukan!</div>
    <div class="modal-message">
      Nama <strong id="dupNameText"></strong> sudah ada di unit lain.<br>
      Apakah ini orang yang sama?
    </div>
    <div class="photo-comparison" id="photoComparison">
      <!-- Photos will be inserted here -->
    </div>
    <div class="modal-message">
      <strong>Pilih salah satu:</strong>
    </div>
    <div style="display: flex; flex-direction: column; gap: 10px;">
      <button class="modal-btn" onclick="confirmSamePerson()">üë§ Orang yang Sama (Pindah Unit)</button>
      <button class="modal-btn modal-btn-secondary" onclick="confirmDifferentPerson()">üë• Orang Berbeda (Buat Data Baru)</button>
      <button class="modal-btn modal-btn-cancel" onclick="closeDuplicateNameModal()">‚ùå Batal</button>
    </div>
  </div>
</div>

<!-- Modal Pindah Unit -->
<div id="pindahUnitModal" class="modal-overlay">
  <div class="modal-content">
    <div class="modal-icon">üîÑ</div>
    <div class="modal-title">Pindah Unit</div>
    <div class="modal-message">
      Pindahkan <strong id="pindahNamaText"></strong> dari unit <strong id="pindahUnitLamaText"></strong> ke unit mana?
    </div>
    <select id="pindahUnitSelect" class="modal-input" style="text-transform: uppercase;">
      <option value="">-- Pilih Unit Tujuan --</option>
      <option value="AKMIL">AKMIL</option>
      <option value="BANDONGAN">BANDONGAN</option>
      <option value="BOROBUDUR">BOROBUDUR</option>
      <option value="BOTTON">BOTTON</option>
      <option value="CANDIMULYO">CANDIMULYO</option>
      <option value="GLAGAH">GLAGAH</option>
      <option value="GRABAG">GRABAG</option>
      <option value="KAJORAN">KAJORAN</option>
      <option value="KALIANGKRIK">KALIANGKRIK</option>
      <option value="KARANGGADING">KARANGGADING</option>
      <option value="KC MAGELANG">KC MAGELANG</option>
      <option value="KCP SHOPPING">KCP SHOPPING</option>
      <option value="KRASAK">KRASAK</option>
      <option value="MAGELANG SELATAN">MAGELANG SELATAN</option>
      <option value="MAGELANG UTARA">MAGELANG UTARA</option>
      <option value="MERTOYUDAN">MERTOYUDAN</option>
      <option value="NGABLAK">NGABLAK</option>
      <option value="PAKIS">PAKIS</option>
      <option value="PAYAMAN">PAYAMAN</option>
      <option value="REJOWINANGUN">REJOWINANGUN</option>
      <option value="SALAMAN">SALAMAN</option>
      <option value="SECANG">SECANG</option>
      <option value="SUKARNO HATTA">SUKARNO HATTA</option>
      <option value="TEGALREJO">TEGALREJO</option>
      <option value="TEMPURAN">TEMPURAN</option>
      <option value="WINDUSARI">WINDUSARI</option>
    </select>
    <div style="display: flex; gap: 10px; justify-content: center; margin-top: 10px;">
      <button class="modal-btn modal-btn-cancel" onclick="closePindahUnitModal()">‚ùå Batal</button>
      <button class="modal-btn" onclick="confirmPindahUnit()">‚úì Pindah Unit</button>
    </div>
  </div>
</div>

<script src="../js/data-personil.js"></script>

<footer>
  <div>¬© 2026 <strong>Database Personil - BRI Magelang</strong></div>
</footer>

</body>
</html>